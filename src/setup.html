<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Whisper Voice - Setup</title>
  <script src="./tailwind.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'app-bg': '#1a1a2e',
            'app-dark': '#0d0d14',
            'app-card': '#16213e',
            'app-accent': '#4a9eff',
            'app-success': '#4ade80',
            'app-error': '#f87171',
          }
        }
      }
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Titlebar */
    .titlebar {
      height: 32px;
      background: rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
      -webkit-app-region: drag;
    }

    .titlebar-title {
      font-size: 12px;
      color: #888;
    }

    .window-controls {
      display: flex;
      -webkit-app-region: no-drag;
    }

    .window-btn {
      width: 46px;
      height: 32px;
      border: none;
      background: transparent;
      color: #888;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .window-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .window-btn.close:hover {
      background: #e81123;
    }

    /* Main Content */
    .setup-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 40px;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      overflow-y: auto;
    }

    /* Logo */
    .logo-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-section img {
      width: 80px;
      height: 80px;
      margin-bottom: 15px;
    }

    .logo-section h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .logo-section p {
      color: #888;
      font-size: 14px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 40px;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.3s;
    }

    .step-dot.active {
      background: #00d4ff;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }

    .step-dot.completed {
      background: #44ff88;
    }

    /* Step Content */
    .step-content {
      flex: 1;
      display: none;
      flex-direction: column;
      animation: fadeIn 0.3s ease;
    }

    .step-content.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      text-align: center;
    }

    .step-description {
      color: #aaa;
      font-size: 14px;
      text-align: center;
      margin-bottom: 30px;
      line-height: 1.5;
    }

    /* Progress Bar */
    .progress-container {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00d4ff, #00a8cc);
      border-radius: 10px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      text-align: center;
      font-size: 13px;
      color: #888;
      margin-bottom: 20px;
    }

    /* Status Log */
    .status-log {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      color: #aaa;
      height: 120px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .status-log .log-entry {
      margin-bottom: 5px;
    }

    .status-log .log-entry.success {
      color: #44ff88;
    }

    .status-log .log-entry.error {
      color: #ff4466;
    }

    .status-log .log-entry.info {
      color: #00d4ff;
    }

    /* Options */
    .options-grid {
      display: grid;
      gap: 15px;
      margin-bottom: 30px;
    }

    .option-card {
      background: rgba(255,255,255,0.05);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .option-card:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(0, 212, 255, 0.3);
    }

    .option-card.selected {
      background: rgba(0, 212, 255, 0.1);
      border-color: #00d4ff;
    }

    .option-card h3 {
      font-size: 16px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-card p {
      font-size: 13px;
      color: #888;
    }

    .option-card .size {
      font-size: 12px;
      color: #00d4ff;
      margin-top: 8px;
    }

    /* Language Selector */
    .language-selector {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    .lang-btn {
      padding: 12px 30px;
      background: rgba(255,255,255,0.05);
      border: 2px solid transparent;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .lang-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    .lang-btn.selected {
      background: rgba(0, 212, 255, 0.15);
      border-color: #00d4ff;
    }

    /* Buttons */
    .button-row {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: auto;
    }

    .btn {
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }

    /* Success Animation */
    .success-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: rgba(68, 255, 136, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .success-icon svg {
      width: 40px;
      height: 40px;
      fill: #44ff88;
    }

    /* Checkbox */
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      margin-bottom: 15px;
      cursor: pointer;
    }

    .checkbox-option input {
      display: none;
    }

    .checkbox-box {
      width: 22px;
      height: 22px;
      border: 2px solid #444;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .checkbox-option input:checked + .checkbox-box {
      background: #00d4ff;
      border-color: #00d4ff;
    }

    .checkbox-box svg {
      width: 14px;
      height: 14px;
      fill: #fff;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .checkbox-option input:checked + .checkbox-box svg {
      opacity: 1;
    }

    .checkbox-label {
      flex: 1;
    }

    .checkbox-label h4 {
      font-size: 14px;
      margin-bottom: 3px;
    }

    .checkbox-label p {
      font-size: 12px;
      color: #888;
    }
  </style>
</head>
<body>
  <!-- Titlebar -->
  <div class="titlebar">
    <span class="titlebar-title">Whisper Voice Setup</span>
    <div class="window-controls">
      <button class="window-btn close" id="closeBtn">
        <svg viewBox="0 0 10 10" width="10" height="10">
          <path d="M1,1 L9,9 M9,1 L1,9" stroke="currentColor" stroke-width="1.2" fill="none"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="setup-container">
    <!-- Logo -->
    <div class="logo-section">
      <img src="../assets/logo.png" alt="Whisper Voice">
      <h1>Whisper Voice</h1>
      <p id="subtitle">Setup-Assistent</p>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step-dot active" data-step="0"></div>
      <div class="step-dot" data-step="1"></div>
      <div class="step-dot" data-step="2"></div>
      <div class="step-dot" data-step="3"></div>
      <div class="step-dot" data-step="4"></div>
    </div>

    <!-- Step 0: Welcome -->
    <div class="step-content active" id="step-0">
      <div class="step-title" data-i18n="welcomeTitle">Willkommen!</div>
      <div class="step-description" data-i18n="welcomeDesc">
        Dieser Assistent installiert alle benötigten Komponenten für Whisper Voice.
        Das dauert nur wenige Minuten.
      </div>

      <div class="language-selector">
        <button class="lang-btn selected" data-lang="de">Deutsch</button>
        <button class="lang-btn" data-lang="en">English</button>
      </div>

      <!-- Detecting existing installations -->
      <div id="detectingSection" style="text-align: center; padding: 20px; color: #888;">
        <div style="margin-bottom: 10px;">
          <svg class="spin" width="24" height="24" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="60" stroke-linecap="round"/>
          </svg>
        </div>
        <span id="detectingText">Suche nach bestehenden Installationen...</span>
      </div>

      <!-- Existing Installation Found - All Ready -->
      <div id="existingReadySection" style="display: none; margin: 20px 0; padding: 15px; background: rgba(68, 255, 136, 0.1); border: 1px solid rgba(68, 255, 136, 0.3); border-radius: 8px;">
        <div style="font-size: 14px; font-weight: 500; margin-bottom: 10px; color: #44ff88;">
          Alles bereit!
        </div>
        <div id="existingReadyInfo" style="font-size: 12px; color: #aaa; margin-bottom: 10px;"></div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-primary" id="useReadyBtn" style="padding: 8px 16px; font-size: 12px;">
            Installation verwenden
          </button>
          <button class="btn" id="upgradePytorchBtn" style="display: none; padding: 8px 16px; font-size: 12px; background: rgba(255, 170, 0, 0.2); border: 1px solid #ffaa00; color: #ffaa00;">
            PyTorch upgraden
          </button>
        </div>
      </div>

      <!-- Existing Python Found - Needs Packages -->
      <div id="existingPythonSection" style="display: none; margin: 20px 0; padding: 15px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px;">
        <div style="font-size: 14px; font-weight: 500; margin-bottom: 10px; color: #00d4ff;">
          Python gefunden
        </div>
        <div id="existingPythonInfo" style="font-size: 12px; color: #aaa; margin-bottom: 10px;"></div>
        <button class="btn btn-primary" id="installPackagesBtn" style="padding: 8px 16px; font-size: 12px;">
          Pakete installieren
        </button>
      </div>

      <!-- No Python Found -->
      <div id="noPythonSection" style="display: none; margin: 20px 0; padding: 15px; background: rgba(255, 68, 102, 0.1); border: 1px solid rgba(255, 68, 102, 0.3); border-radius: 8px;">
        <div style="font-size: 14px; font-weight: 500; margin-bottom: 10px; color: #ff4466;">
          Python nicht gefunden
        </div>
        <div style="font-size: 12px; color: #aaa; margin-bottom: 10px;">
          Bitte installieren Sie Python 3.10 oder neuer von python.org
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" id="openPythonDownload" style="padding: 8px 16px; font-size: 12px;">
            Python herunterladen
          </button>
          <button class="btn btn-secondary" id="retryDetection" style="padding: 8px 16px; font-size: 12px;">
            Erneut suchen
          </button>
        </div>
      </div>

      <div class="button-row" id="startSetupRow" style="display: none;">
        <button class="btn btn-primary" id="startSetup" data-i18n="startSetup">Setup starten</button>
      </div>
    </div>

    <!-- Step 1: Python -->
    <div class="step-content" id="step-1">
      <div class="step-title" data-i18n="pythonTitle">Python installieren</div>
      <div class="step-description" data-i18n="pythonDesc">
        Python wird für die Spracherkennung benötigt.
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="pythonProgress"></div>
      </div>
      <div class="progress-text" id="pythonStatus" data-i18n="preparing">Vorbereiten...</div>

      <div class="status-log" id="pythonLog"></div>

      <div class="button-row">
        <button class="btn btn-primary" id="nextStep1" disabled data-i18n="continue">Weiter</button>
      </div>
    </div>

    <!-- Step 2: FFmpeg -->
    <div class="step-content" id="step-2">
      <div class="step-title" data-i18n="ffmpegTitle">FFmpeg installieren</div>
      <div class="step-description" data-i18n="ffmpegDesc">
        FFmpeg wird für die Audioverarbeitung benötigt.
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="ffmpegProgress"></div>
      </div>
      <div class="progress-text" id="ffmpegStatus" data-i18n="preparing">Vorbereiten...</div>

      <div class="status-log" id="ffmpegLog"></div>

      <div class="button-row">
        <button class="btn btn-primary" id="nextStep2" disabled data-i18n="continue">Weiter</button>
      </div>
    </div>

    <!-- Step 3: Whisper -->
    <div class="step-content" id="step-3">
      <div class="step-title" data-i18n="whisperTitle">Whisper installieren</div>
      <div class="step-description" data-i18n="whisperDesc">
        OpenAI Whisper ist die KI für die Spracherkennung.
      </div>

      <label class="checkbox-option">
        <input type="checkbox" id="cudaOption">
        <div class="checkbox-box">
          <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
        <div class="checkbox-label">
          <h4 data-i18n="cudaTitle">NVIDIA GPU-Beschleunigung</h4>
          <p data-i18n="cudaDesc">Schnellere Transkription mit CUDA (nur für NVIDIA Grafikkarten)</p>
        </div>
      </label>

      <div class="button-row" style="margin-bottom: 20px;">
        <button class="btn btn-primary" id="startWhisperInstall" data-i18n="startInstall">Installation starten</button>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="whisperProgress"></div>
      </div>
      <div class="progress-text" id="whisperStatus" data-i18n="waitingForStart">Warte auf Start...</div>

      <div class="status-log" id="whisperLog"></div>

      <div class="button-row">
        <button class="btn btn-primary" id="nextStep3" disabled data-i18n="continue">Weiter</button>
      </div>
    </div>

    <!-- Step 4: Model Selection -->
    <div class="step-content" id="step-4">
      <div class="step-title" data-i18n="modelTitle">Modell auswählen</div>
      <div class="step-description" data-i18n="modelDesc">
        Wähle ein Sprachmodell. Du kannst dies später in den Einstellungen ändern.
      </div>

      <div class="options-grid">
        <div class="option-card" data-model="tiny">
          <h3>Tiny</h3>
          <p data-i18n="tinyDesc">Schnellste Option, geringere Genauigkeit</p>
          <div class="size">~75 MB</div>
        </div>
        <div class="option-card selected" data-model="base">
          <h3>Base</h3>
          <p data-i18n="baseDesc">Gute Balance für kurze Texte</p>
          <div class="size">~140 MB</div>
        </div>
        <div class="option-card" data-model="small">
          <h3>Small</h3>
          <p data-i18n="smallDesc">Bessere Genauigkeit, noch schnell</p>
          <div class="size">~460 MB</div>
        </div>
        <div class="option-card" data-model="medium">
          <h3>Medium <span style="color: #00d4ff; font-size: 12px;">(Empfohlen)</span></h3>
          <p data-i18n="mediumDesc">Beste Balance aus Geschwindigkeit und Qualität</p>
          <div class="size">~1.5 GB</div>
        </div>
        <div class="option-card" data-model="large">
          <h3>Large</h3>
          <p data-i18n="largeDesc">Höchste Genauigkeit, langsamer</p>
          <div class="size">~2.9 GB</div>
        </div>
      </div>

      <div class="button-row">
        <button class="btn btn-secondary" id="skipModel" data-i18n="skipModel">Überspringen</button>
        <button class="btn btn-primary" id="finishSetup" data-i18n="finishSetup">Abschließen</button>
      </div>
    </div>

    <!-- Step 5: Complete -->
    <div class="step-content" id="step-complete">
      <div class="success-icon">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
      </div>
      <div class="step-title" data-i18n="completeTitle">Setup abgeschlossen!</div>
      <div class="step-description" data-i18n="completeDesc">
        Whisper Voice ist jetzt einsatzbereit. Viel Spaß beim Diktieren!
      </div>

      <div class="button-row">
        <button class="btn btn-primary" id="launchApp" data-i18n="launchApp">App starten</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // Translations
    const translations = {
      de: {
        subtitle: 'Setup-Assistent',
        welcomeTitle: 'Willkommen!',
        welcomeDesc: 'Dieser Assistent installiert alle benötigten Komponenten für Whisper Voice. Das dauert nur wenige Minuten.',
        startSetup: 'Setup starten',
        pythonTitle: 'Python installieren',
        pythonDesc: 'Python wird für die Spracherkennung benötigt.',
        ffmpegTitle: 'FFmpeg installieren',
        ffmpegDesc: 'FFmpeg wird für die Audioverarbeitung benötigt.',
        whisperTitle: 'Whisper installieren',
        whisperDesc: 'OpenAI Whisper ist die KI für die Spracherkennung.',
        cudaTitle: 'NVIDIA GPU-Beschleunigung',
        cudaDesc: 'Schnellere Transkription mit CUDA (nur für NVIDIA Grafikkarten)',
        modelTitle: 'Modell auswählen',
        modelDesc: 'Wähle ein Sprachmodell. Du kannst dies später in den Einstellungen ändern.',
        tinyDesc: 'Schnellste Option, geringere Genauigkeit',
        baseDesc: 'Gute Balance für kurze Texte',
        smallDesc: 'Bessere Genauigkeit, noch schnell',
        mediumDesc: 'Beste Balance aus Geschwindigkeit und Qualität',
        largeDesc: 'Höchste Genauigkeit, langsamer',
        skipModel: 'Überspringen',
        finishSetup: 'Abschließen',
        completeTitle: 'Setup abgeschlossen!',
        completeDesc: 'Whisper Voice ist jetzt einsatzbereit. Viel Spaß beim Diktieren!',
        launchApp: 'App starten',
        continue: 'Weiter',
        preparing: 'Vorbereiten...',
        downloading: 'Herunterladen...',
        extracting: 'Entpacken...',
        installing: 'Installieren...',
        complete: 'Abgeschlossen!',
        error: 'Fehler',
        startInstall: 'Installation starten',
        waitingForStart: 'Warte auf Start...'
      },
      en: {
        subtitle: 'Setup Assistant',
        welcomeTitle: 'Welcome!',
        welcomeDesc: 'This assistant will install all required components for Whisper Voice. It only takes a few minutes.',
        startSetup: 'Start Setup',
        pythonTitle: 'Install Python',
        pythonDesc: 'Python is required for speech recognition.',
        ffmpegTitle: 'Install FFmpeg',
        ffmpegDesc: 'FFmpeg is required for audio processing.',
        whisperTitle: 'Install Whisper',
        whisperDesc: 'OpenAI Whisper is the AI for speech recognition.',
        cudaTitle: 'NVIDIA GPU Acceleration',
        cudaDesc: 'Faster transcription with CUDA (only for NVIDIA graphics cards)',
        modelTitle: 'Select Model',
        modelDesc: 'Choose a speech model. You can change this later in settings.',
        tinyDesc: 'Fastest option, lower accuracy',
        baseDesc: 'Good balance for short texts',
        smallDesc: 'Better accuracy, still fast',
        mediumDesc: 'Best balance of speed and quality',
        largeDesc: 'Highest accuracy, slower',
        skipModel: 'Skip',
        finishSetup: 'Finish',
        completeTitle: 'Setup Complete!',
        completeDesc: 'Whisper Voice is now ready to use. Enjoy dictating!',
        launchApp: 'Launch App',
        continue: 'Continue',
        preparing: 'Preparing...',
        downloading: 'Downloading...',
        extracting: 'Extracting...',
        installing: 'Installing...',
        complete: 'Complete!',
        error: 'Error',
        startInstall: 'Start Installation',
        waitingForStart: 'Waiting to start...'
      }
    };

    let currentLang = 'de';
    let currentStep = 0;
    let selectedModel = 'base';

    // Apply translations
    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
          el.textContent = translations[currentLang][key];
        }
      });
      document.getElementById('subtitle').textContent = translations[currentLang].subtitle;
    }

    // Language selection
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentLang = btn.dataset.lang;
        applyTranslations();
        ipcRenderer.send('setup-language', currentLang);
      });
    });

    // Model selection
    document.querySelectorAll('.option-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedModel = card.dataset.model;
      });
    });

    // Navigation
    function goToStep(step) {
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step-dot').forEach((d, i) => {
        d.classList.remove('active');
        if (i < step) d.classList.add('completed');
        if (i === step) d.classList.add('active');
      });

      const stepEl = document.getElementById(`step-${step}`);
      if (stepEl) {
        stepEl.classList.add('active');
        currentStep = step;
      }
    }

    // Logging
    function addLog(logId, message, type = '') {
      const log = document.getElementById(logId);
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = `> ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    // Progress updates from main process
    ipcRenderer.on('setup-progress', (event, data) => {
      const { step, progress, status, log, type } = data;

      if (progress !== undefined) {
        const progressBar = document.getElementById(`${step}Progress`);
        if (progressBar) progressBar.style.width = `${progress}%`;
      }

      if (status) {
        const statusText = document.getElementById(`${step}Status`);
        if (statusText) statusText.textContent = status;
      }

      if (log) {
        addLog(`${step}Log`, log, type);
      }
    });

    ipcRenderer.on('setup-step-complete', (event, step) => {
      const nextBtn = document.getElementById(`nextStep${step}`);
      if (nextBtn) nextBtn.disabled = false;
    });

    ipcRenderer.on('setup-error', (event, { step, error }) => {
      addLog(`${step}Log`, `Error: ${error}`, 'error');
    });

    // Button handlers
    document.getElementById('startSetup').addEventListener('click', () => {
      goToStep(1);
      ipcRenderer.send('setup-install-python');
    });

    document.getElementById('nextStep1').addEventListener('click', () => {
      goToStep(2);
      ipcRenderer.send('setup-install-ffmpeg');
    });

    document.getElementById('nextStep2').addEventListener('click', () => {
      goToStep(3);
      // Don't auto-start - let user select CUDA option first
    });

    // Start Whisper installation when user clicks the install button
    document.getElementById('startWhisperInstall').addEventListener('click', () => {
      const useCuda = document.getElementById('cudaOption').checked;
      document.getElementById('startWhisperInstall').disabled = true;
      document.getElementById('cudaOption').disabled = true;
      ipcRenderer.send('setup-install-whisper', { cuda: useCuda });
    });

    document.getElementById('nextStep3').addEventListener('click', () => {
      goToStep(4);
    });

    document.getElementById('skipModel').addEventListener('click', () => {
      ipcRenderer.send('setup-complete', { model: null });
      document.getElementById('step-4').classList.remove('active');
      document.getElementById('step-complete').classList.add('active');
    });

    document.getElementById('finishSetup').addEventListener('click', () => {
      ipcRenderer.send('setup-complete', { model: selectedModel });
      document.getElementById('step-4').classList.remove('active');
      document.getElementById('step-complete').classList.add('active');
    });

    document.getElementById('launchApp').addEventListener('click', () => {
      ipcRenderer.send('setup-launch-app');
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      ipcRenderer.send('setup-cancel');
    });

    // Initialize
    applyTranslations();

    // Detect existing installations on startup
    let detectedSystem = null;

    async function detectExistingInstallations() {
      document.getElementById('detectingSection').style.display = 'block';
      document.getElementById('existingReadySection').style.display = 'none';
      document.getElementById('existingPythonSection').style.display = 'none';
      document.getElementById('noPythonSection').style.display = 'none';
      document.getElementById('startSetupRow').style.display = 'none';

      try {
        const result = await ipcRenderer.invoke('setup-detect-system');
        detectedSystem = result;

        document.getElementById('detectingSection').style.display = 'none';

        if (result.ready) {
          // All ready - has Python, torch, whisper, FFmpeg, and GPU works
          document.getElementById('existingReadySection').style.display = 'block';
          let info = `Python ${result.pythonVersion}<br>`;
          info += `PyTorch ${result.torchVersion}`;
          if (result.gpuWorks) {
            info += ` <span style="color: #44ff88;">(GPU: ${result.gpuName})</span>`;
          } else {
            info += ` (CPU)`;
          }
          info += `<br>Whisper + FFmpeg installiert`;

          // Check if CUDA upgrade is available
          if (result.cudaUpgradeAvailable && result.systemCudaVersion && result.recommendedCudaIndex) {
            const recommendedCuda = result.recommendedCudaIndex.split('/').pop();
            info += `<br><br><span style="color: #ffaa00;">⚠ PyTorch uses CUDA ${result.cudaVersion}, but your system has CUDA ${result.systemCudaVersion}</span>`;
            info += `<br><span style="color: #88ccff;">Upgrade available: ${recommendedCuda}</span>`;
            document.getElementById('upgradePytorchBtn').style.display = 'inline-block';
            document.getElementById('upgradePytorchBtn').dataset.indexUrl = result.recommendedCudaIndex;
          } else {
            document.getElementById('upgradePytorchBtn').style.display = 'none';
          }

          document.getElementById('existingReadyInfo').innerHTML = info;
        } else if (result.hasPython) {
          // Has Python but needs packages
          document.getElementById('existingPythonSection').style.display = 'block';
          let info = `Python ${result.pythonVersion}<br>`;

          // Show what's missing
          let missing = [];
          if (result.hasTorch) {
            info += `PyTorch ${result.torchVersion}`;
            if (!result.gpuWorks && result.cudaAvailable) {
              info += ` <span style="color: #ffaa00;">(GPU nicht kompatibel)</span>`;
              missing.push('PyTorch Update');
            }
            info += '<br>';
          } else {
            missing.push('PyTorch');
          }
          if (!result.hasWhisper) {
            missing.push('Whisper');
          }
          if (!result.hasFFmpeg) {
            missing.push('FFmpeg');
          }

          if (missing.length > 0) {
            info += `<span style="color: #ffaa00;">Fehlend: ${missing.join(', ')}</span>`;
          }
          document.getElementById('existingPythonInfo').innerHTML = info;
        } else {
          // No Python found
          document.getElementById('noPythonSection').style.display = 'block';
        }
      } catch (err) {
        console.error('Detection failed:', err);
        document.getElementById('detectingSection').style.display = 'none';
        document.getElementById('noPythonSection').style.display = 'block';
      }
    }

    // Use existing ready installation
    document.getElementById('useReadyBtn').addEventListener('click', async () => {
      if (detectedSystem && detectedSystem.ready) {
        const result = await ipcRenderer.invoke('setup-use-existing', detectedSystem.pythonPath);
        if (result.success) {
          // Mark setup complete and go to model selection
          goToStep(4);
        }
      }
    });

    // Upgrade PyTorch to match system CUDA
    document.getElementById('upgradePytorchBtn').addEventListener('click', async () => {
      const btn = document.getElementById('upgradePytorchBtn');
      const indexUrl = btn.dataset.indexUrl;
      if (!indexUrl) return;

      btn.disabled = true;
      btn.textContent = 'Upgrading...';

      // Go to step 3 to show progress
      goToStep(3);

      // Start the upgrade
      ipcRenderer.send('setup-upgrade-pytorch', { indexUrl });
    });

    // Listen for PyTorch upgrade progress
    ipcRenderer.on('setup-progress', (event, data) => {
      if (data.step === 'pytorch-upgrade') {
        const progressBar = document.querySelector('#step3 .progress');
        const statusText = document.querySelector('#step3 .status-text');
        const logText = document.querySelector('#step3 .log-text');

        if (progressBar) progressBar.style.width = `${data.progress}%`;
        if (statusText) statusText.textContent = data.status;
        if (logText) logText.textContent = data.log;
      }
    });

    // Listen for PyTorch upgrade completion
    ipcRenderer.on('setup-step-complete', (event, step) => {
      if (step === 'pytorch-upgrade') {
        // Re-detect system to verify upgrade
        setTimeout(() => {
          goToStep(0);
          detectExistingInstallations();
        }, 1000);
      }
    });

    // Install packages to existing Python
    document.getElementById('installPackagesBtn').addEventListener('click', async () => {
      if (detectedSystem && detectedSystem.hasPython) {
        // Store the Python path
        await ipcRenderer.invoke('setup-set-python-path', detectedSystem.pythonPath);

        // Determine what needs to be installed
        if (!detectedSystem.hasFFmpeg) {
          // Need FFmpeg first
          goToStep(2);
          ipcRenderer.send('setup-install-ffmpeg');
        } else if (!detectedSystem.hasTorch || !detectedSystem.hasWhisper || !detectedSystem.gpuWorks) {
          // Skip to Whisper/PyTorch installation
          goToStep(3);
          // Auto-check CUDA option if GPU available
          if (detectedSystem.cudaAvailable) {
            document.getElementById('cudaOption').checked = true;
          }
        }
      }
    });

    // Open Python download page
    document.getElementById('openPythonDownload').addEventListener('click', () => {
      require('electron').shell.openExternal('https://www.python.org/downloads/');
    });

    // Retry detection
    document.getElementById('retryDetection').addEventListener('click', () => {
      detectExistingInstallations();
    });

    // Add spin animation
    const style = document.createElement('style');
    style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
    document.head.appendChild(style);

    // Start detection when page loads
    detectExistingInstallations();
  </script>
</body>
</html>
